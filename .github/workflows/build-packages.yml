name: build-ipk (OpenWrt 24.10.2 x86_64)

on:
  push:
    tags: ['*']
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release'
        required: true
        default: 'latest'

permissions:
  contents: write

env:
  RELEASE: 24.10.2
  TARGET: x86
  SUBTARGET: 64
  PKG_DIR_NAME: luci-theme-aurora

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          repository: LemonCrab666/luci-theme-aurora
          ref: master
          fetch-depth: 0

      - name: 从 tag 写入 PKG_RELEASE
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG="${GITHUB_REF_NAME}"
          echo "使用 Tag 作为 PKG_RELEASE: ${TAG}"
          sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=${TAG}/" Makefile
          grep -n '^PKG_RELEASE:=' Makefile || true

      - name: 安装构建依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget zstd \
            nodejs npm
          sudo npm install -g uglify-js clean-css-cli

      - name: 下载并解压 SDK
        run: |
          set -eux
          BASE="https://downloads.openwrt.org/releases/${RELEASE}/targets/${TARGET}/${SUBTARGET}/"
          SDK_TARBALL=$(curl -fsSL "$BASE" | grep -o 'openwrt-sdk-[^"]*\.tar\.zst' | head -n1)
          mkdir -p _sdk
          wget -q "${BASE}${SDK_TARBALL}" -O _sdk/sdk.tar.zst
          tar --zstd -xf _sdk/sdk.tar.zst -C _sdk
          SDK_DIR="$(find "$PWD/_sdk" -maxdepth 1 -type d -name 'openwrt-sdk-*' -print -quit)"
          echo "SDK_DIR=${SDK_DIR}" >> "$GITHUB_ENV"
          echo "Resolved SDK_DIR=${SDK_DIR}"

      - name: 将包拷入 SDK
        run: |
          cd "$SDK_DIR"
          mkdir -p package/${PKG_DIR_NAME}
          rsync -a --delete "$GITHUB_WORKSPACE/" "package/${PKG_DIR_NAME}/" \
            --exclude '.git' --exclude '.github' --exclude '_sdk' --exclude 'out'

      - name: 更新所有 feeds 并安装依赖
        run: |
          cd "$SDK_DIR"
          ./scripts/feeds update -a
          ./scripts/feeds install luci-base luci-compat uhttpd

      - name: 生成默认配置
        run: |
          cd "$SDK_DIR"
          make defconfig

      - name: 清理 SDK
        run: |
          cd "$SDK_DIR"
          make package/${PKG_DIR_NAME}/clean V=s
          make clean V=s

      - name: 编译包
        run: |
          cd "$SDK_DIR"
          make package/${PKG_DIR_NAME}/compile -j1 V=s

      - name: 收集构建产物
        run: |
          cd "$SDK_DIR"
          mkdir -p "$GITHUB_WORKSPACE/out"
          find bin/packages -type f -name "*${PKG_DIR_NAME}*ipk" -print -exec cp -f {} "$GITHUB_WORKSPACE/out/" \;
          cd "$GITHUB_WORKSPACE/out" && sha256sum *.ipk > SHA256SUMS.txt || true && ls -l

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ipks-${{ github.ref_name }}-luci-theme-aurora-x86_64
          path: out/
          if-no-files-found: error

      # - name: 发布到 Releases
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag_name || github.ref_name }}
      #     files: |
      #       out/*.ipk
